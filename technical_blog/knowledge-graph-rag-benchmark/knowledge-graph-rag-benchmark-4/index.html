<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.553">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Dmitriy Leybel">
<meta name="dcterms.date" content="2024-05-16">
<meta name="description" content="Building the answering segment of the QA system centering around the knowledge graph and vector db once both are populated.">

<title>Don‚Äôt RAG on Knowledge Graphs(Or Do) Benchmarking: Combining Knowledge Graphs and Vector DBs to Answer Questions(With Sourcing) ‚Äì Part Four</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="../../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../../">
<link href="../../../images/favicon.ico" rel="icon">
<script src="../../../site_libs/quarto-html/quarto.js"></script>
<script src="../../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="dark">
<script src="../../../site_libs/quarto-contrib/glightbox/glightbox.min.js"></script>
<link href="../../../site_libs/quarto-contrib/glightbox/glightbox.min.css" rel="stylesheet">
<link href="../../../site_libs/quarto-contrib/glightbox/lightbox.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-SB4HQ6BZVQ"></script>

<script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-SB4HQ6BZVQ', { 'anonymize_ip': true});
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>
<script src="https://unpkg.com/@jupyter-widgets/html-manager@*/dist/embed-amd.js" crossorigin="anonymous"></script>


<link rel="stylesheet" href="../../technical_blog.css">
<meta property="og:title" content="Don‚Äôt RAG on Knowledge Graphs(Or Do) Benchmarking: Combining Knowledge Graphs and Vector DBs to Answer Questions(With Sourcing) ‚Äì Part Four">
<meta property="og:description" content="Building the answering segment of the QA system centering around the knowledge graph and vector db once both are populated.">
<meta property="og:image" content="https://www.dmlbl.com/technical_blog/knowledge-graph-rag-benchmark/knowledge-graph-rag-benchmark-4/images/question-answering-flow.png">
<meta property="og:image:height" content="1261">
<meta property="og:image:width" content="1193">
<meta name="twitter:title" content="Don‚Äôt RAG on Knowledge Graphs(Or Do) Benchmarking: Combining Knowledge Graphs and Vector DBs to Answer Questions(With Sourcing) ‚Äì Part Four">
<meta name="twitter:description" content="Building the answering segment of the QA system centering around the knowledge graph and vector db once both are populated.">
<meta name="twitter:image" content="https://www.dmlbl.com/technical_blog/knowledge-graph-rag-benchmark/knowledge-graph-rag-benchmark-4/images/question-answering-flow.png">
<meta name="twitter:creator" content="@dmitriyleybel">
<meta name="twitter:image-height" content="1261">
<meta name="twitter:image-width" content="1193">
<meta name="twitter:card" content="summary_large_image">
</head>

<body class="floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../../../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../../../images/dmlbl_logo.png" alt="" class="navbar-logo">
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../../technical_blog.html"> 
<span class="menu-text">Technical Blog</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../personal_blog.html"> 
<span class="menu-text">Personal Blog</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools tools-wide">
    <a href="../../../resume.html" title="Resume" class="quarto-navigation-tool px-1" aria-label="Resume"><i class="bi bi-file-person-fill"></i></a>
    <a href="https://twitter.com/dmitriyleybel" title="" class="quarto-navigation-tool px-1" aria-label=""><i class="bi bi-twitter-x"></i></a>
    <a href="https://www.linkedin.com/in/dmlbl/" title="" class="quarto-navigation-tool px-1" aria-label=""><i class="bi bi-linkedin"></i></a>
    <a href="mailto:dmleybel@gmail.com" title="" class="quarto-navigation-tool px-1" aria-label=""><i class="bi bi-envelope-fill"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default toc-left page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Don‚Äôt RAG on Knowledge Graphs(Or Do) Benchmarking: Combining Knowledge Graphs and Vector DBs to Answer Questions(With Sourcing) ‚Äì <em>Part Four</em></h1>
                  <div>
        <div class="description">
          Building the answering segment of the QA system centering around the knowledge graph and vector db once both are populated.
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">knowledge-graphs</div>
                <div class="quarto-category">rag</div>
                <div class="quarto-category">benchmarking</div>
                <div class="quarto-category">vector-databases</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Dmitriy Leybel </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">May 16, 2024</p>
      </div>
    </div>
    
      
    </div>
    
  <div>
    <div class="abstract">
      <div class="block-title">Abstract</div>
      This section focuses on constructing a workflow to answer questions found in the <a href="../knowledge-graph-rag-benchmark-0/#musique">MuSiQue</a> dataset. After a long an arduous road of <a href="../../../technical_blog/knowledge-graph-rag-benchmark/knowledge-graph-rag-benchmark-2/index.html">constructing a knowledge graph</a>, <a href="../../../technical_blog/knowledge-graph-rag-benchmark/knowledge-graph-rag-benchmark-3/index.html">adding vector storage</a>, and linking the two, we now have a system that can answer questions with a high degree of accuracy and efficiency(or so we hope).
    </div>
  </div>
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Contents:</h2>
   
  <ul>
  <li><a href="#overview" id="toc-overview" class="nav-link active" data-scroll-target="#overview"><span class="header-section-number">1</span> Overview</a></li>
  <li><a href="#question" id="toc-question" class="nav-link" data-scroll-target="#question"><span class="header-section-number">2</span> Question</a></li>
  <li><a href="#prompting" id="toc-prompting" class="nav-link" data-scroll-target="#prompting"><span class="header-section-number">3</span> Prompting</a>
  <ul class="collapse">
  <li><a href="#prompt-template" id="toc-prompt-template" class="nav-link" data-scroll-target="#prompt-template"><span class="header-section-number">3.1</span> Prompt Template</a></li>
  </ul></li>
  <li><a href="#gathering-evidence" id="toc-gathering-evidence" class="nav-link" data-scroll-target="#gathering-evidence"><span class="header-section-number">4</span> Gathering Evidence</a>
  <ul class="collapse">
  <li><a href="#transforming-the-evidence" id="toc-transforming-the-evidence" class="nav-link" data-scroll-target="#transforming-the-evidence"><span class="header-section-number">4.1</span> Transforming the Evidence</a></li>
  </ul></li>
  <li><a href="#putting-it-all-together" id="toc-putting-it-all-together" class="nav-link" data-scroll-target="#putting-it-all-together"><span class="header-section-number">5</span> Putting It All Together</a>
  <ul class="collapse">
  <li><a href="#moment-of-truth" id="toc-moment-of-truth" class="nav-link" data-scroll-target="#moment-of-truth"><span class="header-section-number">5.1</span> Moment of truth</a></li>
  <li><a href="#copingdeal-with-it" id="toc-copingdeal-with-it" class="nav-link" data-scroll-target="#copingdeal-with-it"><span class="header-section-number">5.2</span> Coping(Deal with it)</a>
  <ul class="collapse">
  <li><a href="#is-a-more-potent-model-the-answer" id="toc-is-a-more-potent-model-the-answer" class="nav-link" data-scroll-target="#is-a-more-potent-model-the-answer"><span class="header-section-number">5.2.1</span> Is a more potent model the answer?</a></li>
  <li><a href="#graph-woes" id="toc-graph-woes" class="nav-link" data-scroll-target="#graph-woes"><span class="header-section-number">5.2.2</span> Graph Woes</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#steps-moving-forward" id="toc-steps-moving-forward" class="nav-link" data-scroll-target="#steps-moving-forward"><span class="header-section-number">6</span> Steps Moving Forward</a></li>
  </ul>
</nav>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
    </div>
<!-- main -->
<main class="content quarto-banner-title-block page-columns page-full" id="quarto-document-content">





<p><strong>On the last episode of</strong>: <a href="../../../technical_blog/knowledge-graph-rag-benchmark/knowledge-graph-rag-benchmark-3/index.html">Don‚Äôt RAG on Knowledge Graphs(Or Do) Benchmarking: Adding a Vector Database ‚Äì Part Three</a>:</p>
<ul>
<li><p>Out of the many available options for vector DBs, we‚Äôre using <a href="../../../technical_blog/knowledge-graph-rag-benchmark/knowledge-graph-rag-benchmark-3/index.html##vector-database-simple-as">Chroma</a> due to its simplicity and ease of use ‚Äì a very powerful plug ‚Äôn play option.</p></li>
<li><p>The nodes in our knowledge graph are linked to <a href="../../../technical_blog/knowledge-graph-rag-benchmark/knowledge-graph-rag-benchmark-3/index.html##vector-database-simple-as#connecting-vector-db-to-knowledge-graph">generated embeddings</a>.</p></li>
<li><p>When we ask a question, we can find the semantically related nodes by generating an embedding for the question and the running a similarity search using a metric like cosine distance.</p></li>
</ul>
<hr>
<section id="overview" class="level1 page-columns page-full" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> Overview</h1>
<p>Below is a flow-charted summary of what this post will be focusing on. The <a href="../knowledge-graph-rag-benchmark-3/">vector database</a> and <a href="../../../technical_blog/knowledge-graph-rag-benchmark/knowledge-graph-rag-benchmark-2/index.html">knowledge graph</a> are generated in previous posts.</p>
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p class="page-columns page-full"><a href="images/question-answering-flow_tnspt.png" class="lightbox page-columns page-full" data-glightbox="description: .lightbox-desc-1" data-gallery="quarto-lightbox-gallery-1" title="Illustrated flow from question to structured answer."><img src="images/question-answering-flow_tnspt.png" class="column-page img-fluid figure-img" alt="Illustrated flow from question to structured answer."></a></p>
<figcaption>Illustrated flow from question to structured answer.</figcaption>
</figure>
</div>
</section>
<section id="question" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> Question</h1>
<p><em>To be or not to be?</em> ü´£</p>
<p>Our purpose here is to answer a question provided a set of paragraphs, and provide the supporting evidence for it.</p>
<p>As a brief reminder, lets peek into a single entry of the MuSiQue dataset used in our previous exploration:</p>
<div style="max-height: 280px; overflow: auto">
<div class="quarto-embed-nb-cell" data-notebook="C:\Users\dmley\OneDrive\Desktop\Sites\dmitriyleybel.github.io\technical_blog\knowledge-graph-rag-benchmark\knowledge-graph-rag-benchmark-1\notebooks\kg_build.ipynb" data-notebook-title="Explore" data-notebook-cellid="cell-81">
<div id="cell-81" class="cell" data-tags="[&quot;main_line&quot;]" data-execution_count="403">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>lines[<span class="op">-</span><span class="dv">2</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="403">
<pre><code>{'id': '2hop__604134_131944',
 'paragraphs': [{'idx': 0,
   'title': 'Commonwealth of the Philippines',
   'paragraph_text': "The Commonwealth of the Philippines (; ) was the administrative body that governed the Philippines from 1935 to 1946, aside from a period of exile in the Second World War from 1942 to 1945 when Japan occupied the country. It replaced the Insular Government, a United States territorial government, and was established by the Tydings‚ÄìMcDuffie Act. The Commonwealth was designed as a transitional administration in preparation for the country's full achievement of independence.",
   'is_supporting': False},
  {'idx': 1,
   'title': 'Lake Oesa',
   'paragraph_text': 'Lake Oesa is a body of water located at an elevation of 2,267m (7438 ft) in the mountains of Yoho National Park, near Field, British Columbia, Canada.',
   'is_supporting': False},
  {'idx': 2,
   'title': 'Arafura Swamp',
   'paragraph_text': 'The Arafura Swamp is a large inland freshwater wetland in Arnhem Land, in the Top End of the Northern Territory of Australia. It is a near pristine floodplain with an area of that may expand to by the end of the wet season, making it the largest wooded swamp in the Northern Territory and, possibly, in Australia. It has a strong seasonal variation in depth of water. The area is of great cultural significance to the Yolngu people, in particular the Ramingining community. It was the filming location for the film "Ten Canoes".',
   'is_supporting': False},
  {'idx': 3,
   'title': 'Wapizagonke Lake',
   'paragraph_text': 'The Wapizagonke Lake is one of the bodies of water located the sector "Lac-Wapizagonke", in the city of Shawinigan, in the La Mauricie National Park, in the region of Mauricie, in Quebec, in Canada.',
   'is_supporting': False},
  {'idx': 4,
   'title': 'Khabarovsky District',
   'paragraph_text': 'Khabarovsky District () is an administrative and municipal district (raion), one of the seventeen in Khabarovsk Krai, Russia. It consists of two unconnected segments separated by the territory of Amursky District, which are located in the southwest of the krai. The area of the district is . Its administrative center is the city of Khabarovsk (which is not administratively a part of the district). Population:',
   'is_supporting': False},
  {'idx': 5,
   'title': 'Silver Lake (Harrisville, New Hampshire)',
   'paragraph_text': 'Silver Lake is a water body located in Cheshire County in southwestern New Hampshire, United States, in the towns of Harrisville and Nelson. Water from Silver Lake flows via Minnewawa Brook and The Branch to the Ashuelot River, a tributary of the Connecticut River.',
   'is_supporting': False},
  {'idx': 6,
   'title': 'Hyderabad',
   'paragraph_text': 'The jurisdictions of the city\'s administrative agencies are, in ascending order of size: the Hyderabad Police area, Hyderabad district, the GHMC area ("Hyderabad city") and the area under the Hyderabad Metropolitan Development Authority (HMDA). The HMDA is an apolitical urban planning agency that covers the GHMC and its suburbs, extending to 54 mandals in five districts encircling the city. It coordinates the development activities of GHMC and suburban municipalities and manages the administration of bodies such as the Hyderabad Metropolitan Water Supply and Sewerage Board (HMWSSB).',
   'is_supporting': False},
  {'idx': 7,
   'title': 'San Juan, Puerto Rico',
   'paragraph_text': "San Juan is located along the north - eastern coast of Puerto Rico. It lies south of the Atlantic Ocean; north of Caguas and Trujillo Alto; east of and Guaynabo; and west of Carolina. The city occupies an area of 76.93 square miles (199.2 km), of which, 29.11 square miles (75.4 km) (37.83%) is water. San Juan's main water bodies are San Juan Bay and two natural lagoons, the Condado and San Jos√©.",
   'is_supporting': False},
  {'idx': 8,
   'title': 'States of Germany',
   'paragraph_text': 'Local associations of a special kind are an amalgamation of one or more Landkreise with one or more Kreisfreie St√§dte to form a replacement of the aforementioned administrative entities at the district level. They are intended to implement simplification of administration at that level. Typically, a district-free city or town and its urban hinterland are grouped into such an association, or Kommunalverband besonderer Art. Such an organization requires the issuing of special laws by the governing state, since they are not covered by the normal administrative structure of the respective states.',
   'is_supporting': False},
  {'idx': 9,
   'title': 'Norfolk Island',
   'paragraph_text': "Norfolk Island is located in the South Pacific Ocean, east of the Australian mainland. Norfolk Island is the main island of the island group the territory encompasses and is located at 29¬∞02‚Ä≤S 167¬∞57‚Ä≤E\ufeff / \ufeff29.033¬∞S 167.950¬∞E\ufeff / -29.033; 167.950. It has an area of 34.6 square kilometres (13.4 sq mi), with no large-scale internal bodies of water and 32 km (20 mi) of coastline. The island's highest point is Mount Bates (319 metres (1,047 feet) above sea level), located in the northwest quadrant of the island. The majority of the terrain is suitable for farming and other agricultural uses. Phillip Island, the second largest island of the territory, is located at 29¬∞07‚Ä≤S 167¬∞57‚Ä≤E\ufeff / \ufeff29.117¬∞S 167.950¬∞E\ufeff / -29.117; 167.950, seven kilometres (4.3 miles) south of the main island.",
   'is_supporting': False},
  {'idx': 10,
   'title': 'Perm',
   'paragraph_text': 'Perm (;) is a city and the administrative centre of Perm Krai, Russia, located on the banks of the Kama River in the European part of Russia near the Ural Mountains.',
   'is_supporting': True},
  {'idx': 11,
   'title': 'Zvezda Stadium',
   'paragraph_text': 'Star (Zvezda) Stadium (), until 1991 Lenin Komsomol Stadium (), is a multi-use stadium in Perm, Russia. It is currently used mostly for football matches and is the home ground of FC Amkar Perm. The stadium holds 17,000 people and was opened on June 5, 1969.',
   'is_supporting': True},
  {'idx': 12,
   'title': 'Paea',
   'paragraph_text': 'Paea is a commune in the suburbs of Papeete in French Polynesia, an overseas territory of France in the southern Pacific Ocean. Paea is located on the island of Tahiti, in the administrative subdivision of the Windward Islands, themselves part of the Society Islands. At the 2017 census it had a population of 13,021.',
   'is_supporting': False},
  {'idx': 13,
   'title': 'Potamogeton amplifolius',
   'paragraph_text': 'Potamogeton amplifolius, commonly known as largeleaf pondweed or broad-leaved pondweed, is an aquatic plant of North America. It grows in water bodies such as lakes, ponds, and rivers, often in deep water.',
   'is_supporting': False},
  {'idx': 14,
   'title': 'Biysky District',
   'paragraph_text': "Biysky District () is an administrative and municipal district (raion), one of the fifty-nine in Altai Krai, Russia. It is located in the east of the krai and borders with Zonalny, Tselinny, Soltonsky, Krasnogorsky, Sovetsky, and Smolensky Districts, as well as with the territory of the City of Biysk. The area of the district is . Its administrative center is the city of Biysk (which is not administratively a part of the district). District's population:",
   'is_supporting': False},
  {'idx': 15,
   'title': 'Contoocook Lake',
   'paragraph_text': 'Contoocook Lake () is a water body located in Cheshire County in southwestern New Hampshire, United States, in the towns of Jaffrey and Rindge. The lake, along with Pool Pond, forms the headwaters of the Contoocook River, which flows north to the Merrimack River in Penacook, New Hampshire.',
   'is_supporting': False},
  {'idx': 16,
   'title': 'Bogot√°',
   'paragraph_text': 'Bogot√° (/ Ààbo ä…°…ôt…ëÀê /, / Àåb…í…°…ôÀàt…ëÀê /, / Àåbo ä - /; Spanish pronunciation: (bo…£oÀàta) (listen)), officially Bogot√°, Distrito Capital, abbreviated Bogot√°, D.C., and formerly known as Santaf√© de Bogot√° between 1991 and 2000, is the capital and largest city of Colombia, administered as the Capital District, although often thought of as part of Cundinamarca. Bogot√° is a territorial entity of the first order, with the same administrative status as the departments of Colombia. It is the political, economic, administrative, industrial, artistic, cultural, and sports center of the country.',
   'is_supporting': False},
  {'idx': 17,
   'title': 'Body water',
   'paragraph_text': "Intracellular fluid (2 / 3 of body water) is fluid contained within cells. In a 72 - kg body containing 40 litres of fluid, about 25 litres is intracellular, which amounts to 62.5%. Jackson's texts states 70% of body fluid is intracellular.",
   'is_supporting': False},
  {'idx': 18,
   'title': 'Territorial waters',
   'paragraph_text': 'Territorial waters or a territorial sea, as defined by the 1982 United Nations Convention on the Law of the Sea, is a belt of coastal waters extending at most 12 nautical miles (22.2 km; 13.8 mi) from the baseline (usually the mean low - water mark) of a coastal state. The territorial sea is regarded as the sovereign territory of the state, although foreign ships (civilian) are allowed innocent passage through it, or transit passage for straits; this sovereignty also extends to the airspace over and seabed below. Adjustment of these boundaries is called, in international law, maritime delimitation.',
   'is_supporting': False},
  {'idx': 19,
   'title': 'Cyprus Popular Bank',
   'paragraph_text': "Cyprus Popular Bank (from 2006 to 2011 known as Marfin Popular Bank) was the second largest banking group in Cyprus behind the Bank of Cyprus until it was 'shuttered' in March 2013 and split into two parts. The 'good' Cypriot part was merged into the Bank of Cyprus (including insured deposits under 100,000 Euro) and the 'bad' part or legacy entity holds all the overseas operations as well as uninsured deposits above 100,000 Euro, old shares and bonds. The uninsured depositors were subject to a bail-in and became the new shareholders of the legacy entity. As at May 2017, the legacy entity is one of the largest shareholders of Bank of Cyprus with 4.8% but does not hold a board seat. All the overseas operations, of the now defunct Cyprus Popular Bank, are also held by the legacy entity, until they are sold by the Special Administrator, at first Ms Andri Antoniadou, who ran the legacy entity for two years, from March 2013 until 3 March 2015. She tendered her resignation due to disagreements, with the Governor of the Central Bank of Cyprus and the Central Bank Board members, who amended the lawyers of the legacy entity, without consulting her. Veteran banker Chris Pavlou who is an expert in Treasury and risk management took over as Special Administrator of the legacy entity in April 2015 until December 2016. The legacy entity is pursuing legal action against former major shareholder Marfin Investment Group.",
   'is_supporting': False}],
 'question': 'What is the body of water by the city where Zvezda stadium is located?',
 'question_decomposition': [{'id': 604134,
   'question': 'Zvezda &gt;&gt; located in the administrative territorial entity',
   'answer': 'Perm',
   'paragraph_support_idx': 11},
  {'id': 131944,
   'question': 'Which is the body of water by #1 ?',
   'answer': 'Kama River',
   'paragraph_support_idx': 10}],
 'answer': 'Kama River',
 'answer_aliases': ['Kama'],
 'answerable': True}</code></pre>
</div>
</div>
</div>
</div>
<p>The question being:</p>
<p><code>What is the body of water by the city where Zvezda stadium is located?</code>.</p>
<p>Simple enough.</p>
<p>The format of the answer is also relevant to us:</p>
<pre><code>{'id': '2hop__252311_366220',
 'predicted_answer': 'Steven Spielberg',
 'predicted_answerable': True,
 'predicted_support_idxs': [10, 18]}</code></pre>
<p>This is taken straight from one of the prediction sets available in <a href="https://github.com/StonyBrookNLP/musique">MuSiQue‚Äôs repo</a>. Steven Spielberg is in fact not a body of water, but a movie director.</p>
<p>Our pipeline‚Äôs output needs to include: 1) The answer 2) Whether the question is answerable given the supporting paragraphs. 3) The paragraphs which contain the supporting information to answer the question.</p>
</section>
<section id="prompting" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> Prompting</h1>
<p>That‚Äôs right, we‚Äôre back to prompting, our bread n buttah.</p>
<p>This time, we‚Äôll be feeding the question, instructions, and supporting evidence to the LLM. This will be very similar to us coaxing the LLM to create the knowledge graph in one of the <a href="../../../technical_blog/knowledge-graph-rag-benchmark/knowledge-graph-rag-benchmark-2/index.html#prompting">previous posts</a>.</p>
<section id="prompt-template" class="level2" data-number="3.1">
<h2 data-number="3.1" class="anchored" data-anchor-id="prompt-template"><span class="header-section-number">3.1</span> Prompt Template</h2>
<p>First, we need a system message that helps guide our model along, delivers and understanding of the input, and gently coerces it to output an aptly formatted answer.</p>
<div class="quarto-embed-nb-cell" data-notebook="C:\Users\dmley\OneDrive\Desktop\Sites\dmitriyleybel.github.io\technical_blog\knowledge-graph-rag-benchmark\knowledge-graph-rag-benchmark-1\notebooks\kg_build.ipynb" data-notebook-title="Explore" data-notebook-cellid="cell-85">
<div id="cell-85" class="cell" data-tags="[&quot;pred_prompts&quot;]" data-execution_count="24">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> langchain_core.messages <span class="im">import</span> SystemMessage</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>guidance_str <span class="op">=</span> <span class="op">\</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="st">"You are the best taker of tests, particularly excelling at </span><span class="ch">\</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="st">answering questions based on information provided to you. </span><span class="ch">\</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="st">You will be given nodes and edges from a knowledge graph in </span><span class="ch">\</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="st">a JSON format and you are expected to answer a question based </span><span class="ch">\</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="st">on them. The 'from_node' and 'to_node' fields in the edges correspond </span><span class="ch">\</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a><span class="st">to the 'connecting_id' fields in the nodes. </span><span class="ch">\</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a><span class="st">Your output will only be JSON, and nothing more. </span><span class="ch">\</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a><span class="st">No yapping.</span><span class="ch">\n</span><span class="st">"</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Answer(BaseModel):</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>    answerable: <span class="bu">bool</span> <span class="op">=</span> Field(..., description<span class="op">=</span><span class="st">"true or false value. Whether or not the answer is answerable based on the provided nodes and edges"</span>)</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>    answer: <span class="bu">str</span> <span class="op">=</span> Field(..., description<span class="op">=</span><span class="st">"The answer to the question. Terse and concise."</span>)</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>    support_idxs: List[<span class="bu">int</span>] <span class="op">=</span> Field(..., description<span class="op">=</span><span class="st">"The indices of the nodes that support the answer. From 'paragraph_idx' field"</span>)</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>format_str <span class="op">=</span> <span class="ss">f"This JSON Schema is the format you will be using: </span><span class="sc">{</span>json<span class="sc">.</span>dumps(Answer.model_json_schema())<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>system_message <span class="op">=</span> SystemMessage(guidance_str <span class="op">+</span> format_str)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>The <code>guidance_str</code> lays out what I described above. We also provide the ‚Äòformat_str‚Äô, which includes a JSON dump of the <code>Answer</code> class schema, brought to you by Pydantic, although this time it‚Äôs a bit less convoluted than the one used to create the nodes and edges of our knowledge graph.</p>
<p>In addition to the System message, we also need to add the Human message template to our pipeline which will allow us to pass in the question and evidence.</p>
<div class="quarto-embed-nb-cell" data-notebook="C:\Users\dmley\OneDrive\Desktop\Sites\dmitriyleybel.github.io\technical_blog\knowledge-graph-rag-benchmark\knowledge-graph-rag-benchmark-1\notebooks\kg_build.ipynb" data-notebook-title="Explore" data-notebook-cellid="cell-89">
<div id="cell-89" class="cell" data-tags="[&quot;human_message_pred&quot;]" data-execution_count="26">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>human_str <span class="op">=</span> <span class="st">"Question: </span><span class="sc">{question}</span><span class="ch">\n\n</span><span class="st"> Supporting Evidence:</span><span class="ch">\n</span><span class="st"> </span><span class="sc">{evidence}</span><span class="st">"</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>human_template <span class="op">=</span> HumanMessagePromptTemplate.from_template(human_str)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</section>
</section>
<section id="gathering-evidence" class="level1" data-number="4">
<h1 data-number="4"><span class="header-section-number">4</span> Gathering Evidence</h1>
<p>Next up, we need to gather the supporting evidence for our model from our knowledge base(the combination of our knowledge graph and vector store which we created in previous posts).</p>
<div style="max-height: 280px; overflow: auto">
<div class="quarto-embed-nb-cell" data-notebook="C:\Users\dmley\OneDrive\Desktop\Sites\dmitriyleybel.github.io\technical_blog\knowledge-graph-rag-benchmark\knowledge-graph-rag-benchmark-1\notebooks\kg_build.ipynb" data-notebook-title="Explore" data-notebook-cellid="cell-102">
<div id="cell-102" class="cell" data-tags="[&quot;top_results_pred&quot;]" data-execution_count="87">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>top_results <span class="op">=</span> collection.query(</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>    query_texts<span class="op">=</span>[lines[<span class="op">-</span><span class="dv">2</span>][<span class="st">'question'</span>]]</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>top_results</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="87">
<pre><code>{'ids': [['6e5f08dc-fe95-4b74-884d-dcce8470290a',
   '7b534168-d2e7-498e-9115-5e21d6c638f3',
   '9a4b69f8-749a-4b7c-a3e3-e2db4f3823d1',
   '7c83cf46-05fc-491d-9667-20acf68fe70f',
   '7956f84b-20a8-4836-ae7a-c7311d716cd1',
   '56ae1a37-74f4-486b-b517-34b99027ba36',
   '631d3937-3f47-4598-8f45-bdb90d5eb91f',
   'c7120f30-4152-4e88-bec1-698bfdd2d5e1',
   'd97d057d-2564-427d-9703-e77a61ff58c7',
   'd86a7f75-df06-47f1-a30d-67a921d822bf']],
 'distances': [[1.3786437511444092,
   1.4539598226547241,
   1.4855282306671143,
   1.501915693283081,
   1.5252399444580078,
   1.5319929122924805,
   1.552965760231018,
   1.5618354082107544,
   1.5635420083999634,
   1.5718779563903809]],
 'metadatas': [[None, None, None, None, None, None, None, None, None, None]],
 'embeddings': None,
 'documents': [["{'semantic_id': 'territorial_waters', 'category': 'geographic_area', 'attributes': {'name': 'territorial waters', 'definition': 'a belt of coastal waters extending at most 12 nautical miles (22.2 km; 13.8 mi) from the baseline (usually the mean low-water mark) of a coastal state', 'source': '1982 United Nations Convention on the Law of the Sea'}, 'paragraph_idx': 18}",
   "{'semantic_id': 'territorial_sea', 'category': 'geographic_area', 'attributes': {'name': 'territorial sea', 'definition': 'a belt of coastal waters extending at most 12 nautical miles (22.2 km; 13.8 mi) from the baseline (usually the mean low-water mark) of a coastal state', 'sovereign_territory': True, 'foreign_ship_passage': 'innocent passage through it or transit passage for straits', 'jurisdiction': 'extends to airspace over and seabed below'}, 'paragraph_idx': 18}",
   "{'semantic_id': 'hmwssb', 'category': 'administrative_body', 'attributes': {'name': 'Hyderabad Metropolitan Water Supply and Sewerage Board', 'type': 'water_management'}}",
   "{'semantic_id': 'arafura_swamp', 'category': 'natural_feature', 'attributes': {'name': 'Arafura Swamp', 'type': 'inland freshwater wetland', 'location': {'region': 'Arnhem Land', 'territory': 'Northern Territory', 'country': 'Australia'}, 'size': {'area': {'value': None, 'unit': 'km2'}, 'expansion_during_wet_season': True}, 'description': 'a near pristine floodplain, possibly the largest wooded swamp in the Northern Territory and Australia', 'cultural_significance': 'of great cultural significance to the Yolngu people, in particular the Ramingining community', 'filming_location': 'Ten Canoes'}, 'paragraph_idx': 2}",
   "{'semantic_id': 'san_juan', 'category': 'city', 'attributes': {'name': 'San Juan', 'location': {'country': 'Puerto Rico', 'region': 'north-eastern coast'}, 'borders': {'north': 'Atlantic Ocean', 'south': ['Caguas', 'Trujillo Alto'], 'east': ['Carolina'], 'west': ['Guaynabo']}, 'area': {'value': 76.93, 'unit': 'square miles'}, 'water_bodies': ['San Juan Bay', 'Condado Lagoon', 'San Jos√© Lagoon'], 'water_area': {'value': 29.11, 'unit': 'square miles', 'percentage': 37.83}}, 'paragraph_idx': 7}",
   "{'semantic_id': 'contoocook_river', 'category': 'river', 'attributes': {'name': 'Contoocook River', 'flow_direction': 'north', 'outflow_destination': 'merrimack_river'}, 'paragraph_idx': 15}",
   "{'semantic_id': 'ghmc_area', 'category': 'administrative_district', 'attributes': {'name': 'GHMC area', 'jurisdiction_size': 'second_largest', 'alternate_name': 'Hyderabad city'}}",
   "{'semantic_id': 'lake_oesa', 'category': 'natural_feature', 'attributes': {'name': 'Lake Oesa', 'elevation': 2267, 'elevation_unit': 'm', 'location': {'park': 'Yoho National Park', 'city': 'Field', 'province': 'British Columbia', 'country': 'Canada'}}, 'paragraph_idx': 1}",
   "{'semantic_id': 'intracellular_fluid', 'category': 'fluid', 'attributes': {'name': 'intracellular fluid', 'volume': '2/3 of body water', 'amount_in_72_kg_body': '25 litres', 'percentage_of_total_body_fluid': 62.5}, 'paragraph_idx': 17}",
   "{'semantic_id': 'strait', 'category': 'geographic_feature', 'attributes': {'name': 'strait', 'sovereign_territory': True, 'jurisdiction': {'airspace': True, 'seabed': True}}, 'paragraph_idx': 18}"]],
 'uris': None,
 'data': None}</code></pre>
</div>
</div>
</div>
</div>
<p>We‚Äôre interested in the top 3 results. Why? Why not?</p>
<div class="quarto-embed-nb-cell" data-notebook="C:\Users\dmley\OneDrive\Desktop\Sites\dmitriyleybel.github.io\technical_blog\knowledge-graph-rag-benchmark\knowledge-graph-rag-benchmark-1\notebooks\kg_build.ipynb" data-notebook-title="Explore" data-notebook-cellid="cell-106">
<div id="cell-106" class="cell" data-tags="[&quot;top_nodes_preview&quot;]" data-execution_count="90">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>uuid_strs <span class="op">=</span> top_results[<span class="st">'ids'</span>][<span class="dv">0</span>][:<span class="dv">3</span>]</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>top_uuids <span class="op">=</span> [uuid.UUID(uuid_str, version<span class="op">=</span><span class="dv">4</span>) <span class="cf">for</span> uuid_str <span class="kw">in</span> uuid_strs]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>We get the top UUIDs to then use in conjuction with our <code>UUID: graph index</code> mapping we constructed during the creation of the knowledge graph.</p>
<p>Lets take a gander into the connecting nodes from our top 3 results. Our network graph is <strong>directed</strong>, meaning that the direction is important(and creates a much easier semantic designation for the edge). A predecessor node is a node from which the linkage stems, and a successor node is the node towards which the linkage is directed. Taking their union, we have an exhaustive list of connecting nodes to the ones we retrieved from our vector store.</p>
<div class="quarto-embed-nb-cell" data-notebook="C:\Users\dmley\OneDrive\Desktop\Sites\dmitriyleybel.github.io\technical_blog\knowledge-graph-rag-benchmark\knowledge-graph-rag-benchmark-1\notebooks\kg_build.ipynb" data-notebook-title="Explore" data-notebook-cellid="cell-108">
<div id="cell-108" class="cell" data-tags="[&quot;suc_pred_nodes&quot;]" data-execution_count="91">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> top_uuid <span class="kw">in</span> top_uuids:</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> idx <span class="kw">in</span> <span class="bu">list</span>(digraph.successor_indices(node_indices[top_uuid])) <span class="op">+</span> <span class="bu">list</span>(digraph.predecessor_indices(node_indices[top_uuid])):</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(digraph[idx])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>{'semantic_id': 'coastal_state', 'category': 'legal_entity', 'attributes': {'name': 'coastal state'}}
{'semantic_id': 'baseline', 'category': 'geographic_feature', 'attributes': {'name': 'baseline', 'definition': 'usually the mean low-water mark of a coastal state'}}
{'semantic_id': 'baseline', 'category': 'geographic_feature', 'attributes': {'name': 'baseline', 'definition': 'usually the mean low-water mark of a coastal state'}}
{'semantic_id': 'coastal_state', 'category': 'legal_entity', 'attributes': {'name': 'coastal state'}}
{'semantic_id': 'hmda_area', 'category': 'administrative_district', 'attributes': {'name': 'Hyderabad Metropolitan Development Authority (HMDA) area', 'jurisdiction_size': 'largest', 'type': 'urban_planning_agency', 'apolitical': True, 'covers': ['ghmc_area', 'suburbs_of_ghmc_area']}, 'paragraph_idx': 6}</code></pre>
</div>
</div>
</div>
<section id="transforming-the-evidence" class="level2" data-number="4.1">
<h2 data-number="4.1" class="anchored" data-anchor-id="transforming-the-evidence"><span class="header-section-number">4.1</span> Transforming the Evidence</h2>
<p>Now that we have the nodes, we need to grab their edges, and then transform both into a format that will be easily digestible for the LLM. We will still feed the nodes and edges as JSON strings, but we‚Äôll need to augment it to replace UUIDs with something less complex like a monotonically increasing integer. This way, the LLM can use integers like <code>0</code> and <code>1</code> instead of <code>5f092031-cf0d-408c-a4f1-896e7c8607be</code> and <code>bc1c5af9-c311-4e9f-975d-349d33d41a15</code> when interpreting the <code>from_node</code> and <code>to_node</code> fields of the edges.</p>
<div style="max-height: 530px; overflow: auto">
<div class="quarto-embed-nb-cell" data-notebook="C:\Users\dmley\OneDrive\Desktop\Sites\dmitriyleybel.github.io\technical_blog\knowledge-graph-rag-benchmark\knowledge-graph-rag-benchmark-1\notebooks\kg_build.ipynb" data-notebook-title="Explore" data-notebook-cellid="cell-109">
<div id="cell-109" class="cell" data-tags="[&quot;evidence_processing&quot;]" data-execution_count="92">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> copy</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>node_hist_dict <span class="op">=</span> {} <span class="co"># idx: obj mapping</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>edge_hist_dict <span class="op">=</span> {} <span class="co"># (from_idx, to_idx): obj mapping</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>uuid_list <span class="op">=</span> [] <span class="co"># used for dup checking</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>id_counter <span class="op">=</span> <span class="dv">0</span> <span class="co"># used for creating new easily-parseable ids</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> top_uuid <span class="kw">in</span> top_uuids:</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>    top_idx <span class="op">=</span> node_indices[top_uuid]</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>    uuid_list.append(top_uuid)</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>    successor_idxs <span class="op">=</span> [(<span class="st">'s'</span>, successor) <span class="cf">for</span> successor <span class="kw">in</span> digraph.successor_indices(top_idx)]</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>    predecessor_idxs <span class="op">=</span> [(<span class="st">'p'</span>, predecessor) <span class="cf">for</span> predecessor <span class="kw">in</span> digraph.predecessor_indices(top_idx)]</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>    neighbor_idxs <span class="op">=</span> successor_idxs <span class="op">+</span> predecessor_idxs</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> top_idx <span class="kw">not</span> <span class="kw">in</span> node_hist_dict: <span class="co"># Add the top node if it's not already in the node_hist_dict</span></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>        main_node <span class="op">=</span> copy.deepcopy(digraph[top_idx])</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>        main_node[<span class="st">'connecting_id'</span>] <span class="op">=</span> id_counter</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>        node_hist_dict[top_idx] <span class="op">=</span> main_node</span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>        id_counter <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>        main_node <span class="op">=</span> node_hist_dict[top_idx]</span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="bu">len</span>(neighbor_idxs) <span class="op">&gt;</span> <span class="dv">0</span>):</span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> connection_type, idx <span class="kw">in</span> neighbor_idxs: </span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> idx <span class="kw">in</span> node_hist_dict:</span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>                secondary_connecting_id <span class="op">=</span> node_hist_dict[idx][<span class="st">'connecting_id'</span>]</span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>                secondary_connecting_id <span class="op">=</span> id_counter</span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a>                node_hist_dict[idx] <span class="op">=</span> copy.deepcopy(digraph[idx])</span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a>                node_hist_dict[idx][<span class="st">'connecting_id'</span>] <span class="op">=</span> secondary_connecting_id</span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a>                id_counter <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a>            <span class="co"># If the connections are already in the edge_hist_dict, skip</span></span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> ((connection_type <span class="op">==</span> <span class="st">'s'</span> <span class="kw">and</span> (top_idx, idx) <span class="kw">in</span> edge_hist_dict) <span class="kw">or</span> </span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a>                (connection_type <span class="op">==</span> <span class="st">'p'</span> <span class="kw">and</span> (idx, top_idx) <span class="kw">in</span> edge_hist_dict)):</span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a>                <span class="cf">continue</span></span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a>            <span class="cf">elif</span> connection_type <span class="op">==</span> <span class="st">'s'</span>:</span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a>                edge_hist_dict[(top_idx, idx)] <span class="op">=</span> copy.deepcopy(digraph.get_edge_data(top_idx, idx))</span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true" tabindex="-1"></a>                edge_hist_dict[(top_idx, idx)][<span class="st">'from_node'</span>] <span class="op">=</span> main_node[<span class="st">'connecting_id'</span>]</span>
<span id="cb11-36"><a href="#cb11-36" aria-hidden="true" tabindex="-1"></a>                edge_hist_dict[(top_idx, idx)][<span class="st">'to_node'</span>] <span class="op">=</span> secondary_connecting_id</span>
<span id="cb11-37"><a href="#cb11-37" aria-hidden="true" tabindex="-1"></a>            <span class="cf">elif</span> connection_type <span class="op">==</span> <span class="st">'p'</span>:</span>
<span id="cb11-38"><a href="#cb11-38" aria-hidden="true" tabindex="-1"></a>                edge_hist_dict[(idx, top_idx)] <span class="op">=</span> copy.deepcopy(digraph.get_edge_data(idx, top_idx))</span>
<span id="cb11-39"><a href="#cb11-39" aria-hidden="true" tabindex="-1"></a>                edge_hist_dict[(idx, top_idx)][<span class="st">'from_node'</span>] <span class="op">=</span> secondary_connecting_id</span>
<span id="cb11-40"><a href="#cb11-40" aria-hidden="true" tabindex="-1"></a>                edge_hist_dict[(idx, top_idx)][<span class="st">'to_node'</span>] <span class="op">=</span> main_node[<span class="st">'connecting_id'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
For the astute reader, you may have noticed that we could‚Äôve just used the integer values that are the indices of the nodes in the network graph. Intuitively, it makes more sense to me to use smaller integers by creating a new counter for each presentation of evidence. In practice, this may not be the case.
</div>
</div>
<div class="callout-body-container callout-body">

</div>
</div>
<p>Lets take a look at what the evidence will look like:</p>
<div style="max-height: 530px; overflow: auto">
<div class="quarto-embed-nb-cell" data-notebook="C:\Users\dmley\OneDrive\Desktop\Sites\dmitriyleybel.github.io\technical_blog\knowledge-graph-rag-benchmark\knowledge-graph-rag-benchmark-1\notebooks\kg_build.ipynb" data-notebook-title="Explore" data-notebook-cellid="cell-112">
<div id="cell-112" class="cell" data-tags="[&quot;edges_nodes_hist&quot;]" data-execution_count="94">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>pprint(<span class="bu">list</span>({<span class="op">**</span>node_hist_dict, <span class="op">**</span>edge_hist_dict}.values()))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[{'attributes': {'definition': 'a belt of coastal waters extending at most 12 '
                               'nautical miles (22.2 km; 13.8 mi) from the '
                               'baseline (usually the mean low-water mark) of '
                               'a coastal state',
                 'name': 'territorial waters',
                 'source': '1982 United Nations Convention on the Law of the '
                           'Sea'},
  'category': 'geographic_area',
  'connecting_id': 0,
  'paragraph_idx': 18,
  'semantic_id': 'territorial_waters'},
 {'attributes': {'name': 'coastal state'},
  'category': 'legal_entity',
  'connecting_id': 1,
  'semantic_id': 'coastal_state'},
 {'attributes': {'definition': 'usually the mean low-water mark of a coastal '
                               'state',
                 'name': 'baseline'},
  'category': 'geographic_feature',
  'connecting_id': 2,
  'semantic_id': 'baseline'},
 {'attributes': {'definition': 'a belt of coastal waters extending at most 12 '
                               'nautical miles (22.2 km; 13.8 mi) from the '
                               'baseline (usually the mean low-water mark) of '
                               'a coastal state',
                 'foreign_ship_passage': 'innocent passage through it or '
                                         'transit passage for straits',
                 'jurisdiction': 'extends to airspace over and seabed below',
                 'name': 'territorial sea',
                 'sovereign_territory': True},
  'category': 'geographic_area',
  'connecting_id': 3,
  'paragraph_idx': 18,
  'semantic_id': 'territorial_sea'},
 {'attributes': {'name': 'Hyderabad Metropolitan Water Supply and Sewerage '
                         'Board',
                 'type': 'water_management'},
  'category': 'administrative_body',
  'connecting_id': 4,
  'semantic_id': 'hmwssb'},
 {'attributes': {'apolitical': True,
                 'covers': ['ghmc_area', 'suburbs_of_ghmc_area'],
                 'jurisdiction_size': 'largest',
                 'name': 'Hyderabad Metropolitan Development Authority (HMDA) '
                         'area',
                 'type': 'urban_planning_agency'},
  'category': 'administrative_district',
  'connecting_id': 5,
  'paragraph_idx': 6,
  'semantic_id': 'hmda_area'},
 {'category': 'belongs_to', 'from_node': 0, 'to_node': 1},
 {'category': 'extends_from', 'from_node': 0, 'to_node': 2},
 {'category': 'extends_from', 'from_node': 3, 'to_node': 2},
 {'category': 'belongs_to', 'from_node': 3, 'to_node': 1},
 {'category': 'manages', 'from_node': 5, 'to_node': 4}]</code></pre>
</div>
</div>
</div>
</div>
<p>You can now see the nodes have <code>connecting_ids</code> 0-4 which are then used in the <code>from_node</code> and <code>to_node</code> fields of the edges.</p>
</section>
</section>
<section id="putting-it-all-together" class="level1" data-number="5">
<h1 data-number="5"><span class="header-section-number">5</span> Putting It All Together</h1>
<p>We‚Äôve got the evidence, now we need to finalize our pipeline check the response from the LLM.</p>
<p>First, lets combine our <code>System</code> and <code>Human</code> templates.</p>
<div class="quarto-embed-nb-cell" data-notebook="C:\Users\dmley\OneDrive\Desktop\Sites\dmitriyleybel.github.io\technical_blog\knowledge-graph-rag-benchmark\knowledge-graph-rag-benchmark-1\notebooks\kg_build.ipynb" data-notebook-title="Explore" data-notebook-cellid="cell-114">
<div id="cell-114" class="cell" data-tags="[&quot;combined_template&quot;]" data-execution_count="54">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>combined_template <span class="op">=</span> system_message <span class="op">+</span> human_template</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>combined_template</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="54">
<pre><code>ChatPromptTemplate(input_variables=['evidence', 'question'], messages=[SystemMessage(content='You are the best taker of tests, particularly excelling at answering questions based on information provided to you. You will be given nodes and edges from a knowledge graph in a JSON format and you are expected to answer a question based on them. The \'from_node\' and \'to_node\' fields in the edges correspond to the \'connecting_id\' fields in the nodes. Your output will only be JSON, and nothing more. No yapping.\nThis JSON Schema is the format you will be using: {"properties": {"answerable": {"description": "true or false value. Whether or not the answer is answerable based on the provided nodes and edges", "title": "Answerable", "type": "boolean"}, "answer": {"description": "The answer to the question. Terse and concise.", "title": "Answer", "type": "string"}, "support_idxs": {"description": "The indices of the nodes that support the answer. From \'paragraph_idx\' field", "items": {"type": "integer"}, "title": "Support Idxs", "type": "array"}}, "required": ["answerable", "answer", "support_idxs"], "title": "Answer", "type": "object"}'), HumanMessagePromptTemplate(prompt=PromptTemplate(input_variables=['evidence', 'question'], template='Question: {question}\n\n Supporting Evidence:\n {evidence}'))])</code></pre>
</div>
</div>
</div>
<p>Next, we need to wrap our Pydantic class <code>Answer</code> in a <code>PydanticOutputParser</code>, which takes the output from the LLM model and parses the string as a JSON, erroring out if the structure does not match our schema. We then wrap that parser in an <code>OutputFixingParser</code>, which will attempt to fix any errors that may occur during the parsing process by passing the error and output back to the LLM for remediation.</p>
<div class="quarto-embed-nb-cell" data-notebook="C:\Users\dmley\OneDrive\Desktop\Sites\dmitriyleybel.github.io\technical_blog\knowledge-graph-rag-benchmark\knowledge-graph-rag-benchmark-1\notebooks\kg_build.ipynb" data-notebook-title="Explore" data-notebook-cellid="cell-91">
<div id="cell-91" class="cell" data-tags="[&quot;parse_pydantic&quot;]" data-execution_count="30">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> langchain.output_parsers <span class="im">import</span> PydanticOutputParser, OutputFixingParser</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>_output_parser <span class="op">=</span> PydanticOutputParser(pydantic_object<span class="op">=</span>Answer)</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>output_parser <span class="op">=</span> OutputFixingParser.from_llm(parser<span class="op">=</span>_output_parser, llm<span class="op">=</span>chat_model, max_retries<span class="op">=</span><span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<section id="moment-of-truth" class="level2" data-number="5.1">
<h2 data-number="5.1" class="anchored" data-anchor-id="moment-of-truth"><span class="header-section-number">5.1</span> Moment of truth</h2>
<p>We can now instantiate the pipeline, pass in the question and evidence, then run it.</p>
<div class="quarto-embed-nb-cell" data-notebook="C:\Users\dmley\OneDrive\Desktop\Sites\dmitriyleybel.github.io\technical_blog\knowledge-graph-rag-benchmark\knowledge-graph-rag-benchmark-1\notebooks\kg_build.ipynb" data-notebook-title="Explore" data-notebook-cellid="cell-115">
<div id="cell-115" class="cell" data-tags="[&quot;ans_pipe&quot;]" data-execution_count="95">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>answer_pipe <span class="op">=</span> combined_template <span class="op">|</span> chat_model <span class="op">|</span> output_parser</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>evidence <span class="op">=</span> <span class="bu">str</span>(<span class="bu">list</span>({<span class="op">**</span>node_hist_dict, <span class="op">**</span>edge_hist_dict}.values()))</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>question <span class="op">=</span> lines[<span class="op">-</span><span class="dv">2</span>][<span class="st">'question'</span>]</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>ans <span class="op">=</span> answer_pipe.invoke({<span class="st">'question'</span>: question, <span class="st">'evidence'</span>: evidence})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<div class="quarto-embed-nb-cell" data-notebook="C:\Users\dmley\OneDrive\Desktop\Sites\dmitriyleybel.github.io\technical_blog\knowledge-graph-rag-benchmark\knowledge-graph-rag-benchmark-1\notebooks\kg_build.ipynb" data-notebook-title="Explore" data-notebook-cellid="cell-116">
<div id="cell-116" class="cell" data-tags="[&quot;wrong_ans&quot;]" data-execution_count="96">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>question, ans, lines[<span class="op">-</span><span class="dv">2</span>][<span class="st">'answer'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="96">
<pre><code>('What is the body of water by the city where Zvezda stadium is located?',
 Answer(answerable=True, answer='The Hussain Sagar lake', support_idxs=[5, 6]),
 'Kama River')</code></pre>
</div>
</div>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="images/cman_c.jpg" class="lightbox" data-glightbox="description: .lightbox-desc-2" data-gallery="quarto-lightbox-gallery-2" title="It‚Äôs okay to feel all sorts of things when you don‚Äôt get your expected result."><img src="images/cman_c.jpg" class="img-fluid figure-img" alt="It‚Äôs okay to feel all sorts of things when you don‚Äôt get your expected result."></a></p>
<figcaption>It‚Äôs okay to feel all sorts of things when you don‚Äôt get your expected result.</figcaption>
</figure>
</div>
<ol type="1">
<li>What</li>
</ol>
<p>The supporting evidence makes no mention of <code>The Hussain Sagar lake</code>, however I <strong>did</strong> look it up, and found that it is located in Hyderabad, which <strong>is</strong> in our evidence. Here, we see the model looking into its own trained knowledgebase and ignoring the evidence.</p>
</section>
<section id="copingdeal-with-it" class="level2" data-number="5.2">
<h2 data-number="5.2" class="anchored" data-anchor-id="copingdeal-with-it"><span class="header-section-number">5.2</span> Coping(Deal with it)</h2>
<p>I‚Äôm not going to lie to you; I was not expecting the correct answer on the first trial run. Once we have an end-to-end pipeline established, it needs to be tuned to the task at hand. In order to tune a model, the best practice is to understand where its deficiencies lie.</p>
<p>According to the dataset, the supporting evidence comes from paragraphs 10 and 11, neither of which made it to our evidence.</p>
<p><strong>10</strong>:</p>
<pre><code>   Perm (;) is a city and the administrative centre of Perm Krai, Russia, located on
   the banks of the Kama River in the European part of Russia near the Ural Mountains.</code></pre>
<p><strong>11</strong>:</p>
<pre><code>   Star (Zvezda) Stadium (), until 1991 Lenin Komsomol Stadium (), is a multi-use stadium in
   Perm, Russia. It is currently used mostly for football matches and is the home ground of FC
   Amkar Perm. The stadium holds 17,000 people and was opened on June 5, 1969.</code></pre>
<p>Not only was the answer wrong, but the LLM believed that the question was <strong>answerable</strong> given the available evidence.</p>
<section id="is-a-more-potent-model-the-answer" class="level3" data-number="5.2.1">
<h3 data-number="5.2.1" class="anchored" data-anchor-id="is-a-more-potent-model-the-answer"><span class="header-section-number">5.2.1</span> Is a more potent model the answer?</h3>
<p>Given that the evidence does not contribute to the correct answer, we can say that our model is hallucinating due to it marking it as <em>answerable</em> and giving us the wrong answer. Weak models tend to hallucinate often. Could this be the case here? Lets use a more powerful model to test out our hypothesis.</p>
<div class="quarto-embed-nb-cell" data-notebook="C:\Users\dmley\OneDrive\Desktop\Sites\dmitriyleybel.github.io\technical_blog\knowledge-graph-rag-benchmark\knowledge-graph-rag-benchmark-1\notebooks\kg_build.ipynb" data-notebook-title="Explore" data-notebook-cellid="cell-121">
<div id="cell-121" class="cell" data-tags="[&quot;adv_model&quot;]" data-execution_count="98">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>chat_model_adv <span class="op">=</span> ChatAnthropic(model_name<span class="op">=</span><span class="st">"claude-3-opus-20240229"</span>)</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>answer_pipe <span class="op">=</span> combined_template <span class="op">|</span> chat_model_adv <span class="op">|</span> output_parser</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>evidence <span class="op">=</span> <span class="bu">str</span>(<span class="bu">list</span>({<span class="op">**</span>node_hist_dict, <span class="op">**</span>edge_hist_dict}.values()))</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>question <span class="op">=</span> lines[<span class="op">-</span><span class="dv">2</span>][<span class="st">'question'</span>]</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>ans_adv <span class="op">=</span> answer_pipe.invoke({<span class="st">'question'</span>: question, <span class="st">'evidence'</span>: evidence})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>This is a more sensible answer, using the evidence correctly; no good evidence, not answerable. As things should be.</p>
<p>It will be useful to outline the problems and their corresponding potential solutions to explore.</p>
<p><strong>Problem 1</strong>: The LLM believes the question is answerable, when it is not and the model hallucinates information.</p>
<p><strong>Solution 1a</strong>: Use a more powerful model. This isn‚Äôt a hard ask, given the exponential improvement and falling costs.</p>
<p><strong>Solution 1b</strong>: Add a chain-of-thought step. e.g.&nbsp;add a field to the output template that produces the reasoning behind the answer. This may be an acceptable solution when combined with a weak model.</p>
</section>
<section id="graph-woes" class="level3" data-number="5.2.2">
<h3 data-number="5.2.2" class="anchored" data-anchor-id="graph-woes"><span class="header-section-number">5.2.2</span> Graph Woes</h3>
<p>The evidence returned by our pipeline is inadequate. We can look through the knowledge graph carefully and see that the nodes and edges present in the knowledge graphs contain information that <strong>IS capable</strong> of answering the question.</p>
<p>The following nodes are present within the knowledge graph:</p>
<pre><code>{'semantic_id': 'star_stadium',
                'category': 'stadium',
                'attributes': {'name': 'Star (Zvezda) Stadium',
                 'former_name': 'Lenin Komsomol Stadium',
                 'location': {'city': 'Perm', 'country': 'Russia'},
                 'usage': 'football matches',
                 'home_team': 'FC Amkar Perm',
                 'capacity': 17000,
                 'opened': '1969-06-05'}}})</code></pre>
<pre><code>{'semantic_id': 'perm',
                'category': 'city',
                'attributes': {'name': 'Perm',
                 'location': {'river': 'Kama River',
                  'region': 'Perm Krai',
                  'country': 'Russia',
                  'geography': 'European part of Russia near the Ural Mountains'},
                 'administrative_status': 'administrative centre'}}})</code></pre>
<p>As is the connection between them:</p>
<pre><code>{'from_node': UUID('08f207c1-6915-4237-ac4e-902815d9cfae'),
                'to_node': UUID('5be79bf7-cd2a-487f-8833-36ae11257df8'),
                'category': 'located_in'}})</code></pre>
<p>We‚Äôve found a limitation of the semantic search. The semantics/vibes of the question matched the incorrect evidence. We can‚Äôt say exactly why, but it could simply be the amount of water-adjaced terminology found in the question and the answer. Or it could be something else entirely. This sort of latent space analysis is tough, and sometimes impossible to do well.</p>
<p><strong>Problem 2</strong>: Searching our vector store for the correct nodes is inadequate. We need more than merely capture the gist of the passage based on the encoding.</p>
<p><strong>Solution 2a</strong>: Use a <a href="https://arxiv.org/abs/2212.10496">HyDE approach</a> where we can use an LLM to generate hypothetical questions to accompany the node information dump, so that the vector search is more likely to match the embedding of the question to the node.</p>
<p><strong>Solution 2b</strong>: Hybrid search. By combining a sparse search(word-matching) and a dense search(embedding-based), we can capture the exact terminology of the question better. ‚ÄúSvezda stadium‚Äù would be a more likely match in that case. Also, because ‚Äòsvezda‚Äô is a Russian word for ‚Äòstar‚Äô, the dense/semantic search would be more likely to capture the node if someone asks about ‚ÄúStar Stadium‚Äù, even though ‚ÄòSvezda‚Äô isn‚Äôt part of the question.</p>
</section>
</section>
</section>
<section id="steps-moving-forward" class="level1" data-number="6">
<h1 data-number="6"><span class="header-section-number">6</span> Steps Moving Forward</h1>
<p>Closing up, lets speak about the road ahead:</p>
<ol type="1">
<li><strong>Composability</strong>: We have our rough outline of steps, which I reluctantly call a pipeline, that are necessary to go from paragraphs and a question to an evidenced answer. Moving forward, this should be a simple workflow which we can use to loop over any number of given items.</li>
<li><strong>Error handling</strong>: Some more error handling would be nice. Some of the code that generates the knowledge graph needs to be reworked in order to error out and retry generating the nodes and edges of a particular text chunk when it hallucinates connections. I‚Äôve seen it make up <code>semantic_ids</code> when creating edges, which reduces the quality of our graph because now we can‚Äôt use those edges, and they‚Äôve likely taken the place of useful ones. This would function similarly to the <code>OutputFixingParser</code> we used to wrap our <code>PydanticOutputParser</code> and allow it to self-correct.</li>
<li><strong>Graph Connection Generation:</strong> After our knowledge graph is generated, we can allow a few random(or not so random) passes of the LLM as discussed in <a href="../knowledge-graph-rag-benchmark-1/#letting-the-llm-loose">part one</a> to potentially create connections between disparate nodes. This step is probably not necessary given the relatively small size of the paragraphs, but it would be immensely useful for entity resolution and graph refinement for a larger corpus of text.</li>
<li><strong>Chunk augmentation and prompt size expansion:</strong> It may be a good idea to also tune the chunk size we‚Äôre using to speed things up and increase performance as well as keep a larger track of nodes in our passed in history. I‚Äôm hesitant to do this because I want this approach to be as versatile as possible, and easily transferable to rely solely on local machines.</li>
<li><strong>(Teaser) DSPy Prompt Tuning</strong>: As a further goal, being able to optimize the prompts we‚Äôre using would be a great benefit, and remove the arduous task of manually trying to condition an clever prompt. A further benefit of this is that modularizing the workflow this way allows also for being able to generate examples and tune smaller models which are comparably capable. <em>This requires more effort and time, and something I‚Äôd like to get to eventually.</em></li>
</ol>


<div class="hidden" aria-hidden="true">
<span class="glightbox-desc lightbox-desc-1">Illustrated flow from question to structured answer.</span>
<span class="glightbox-desc lightbox-desc-2">It‚Äôs okay to feel all sorts of things when you don‚Äôt get your expected result.</span>
</div>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "Óßã";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/www\.dmlbl\.com");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">
      <ul class="footer-items list-unstyled">
    <li class="nav-item">
 ¬© 2024 - Dmitriy Leybel
  </li>  
    <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/dmitriyleybel">
      <i class="bi bi-twitter-x" role="img">
</i> 
    </a>
  </li>  
    <li class="nav-item compact">
    <a class="nav-link" href="https://www.linkedin.com/in/dmlbl/">
      <i class="bi bi-linkedin" role="img">
</i> 
    </a>
  </li>  
</ul>
    </div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>
<script>var lightboxQuarto = GLightbox({"descPosition":"bottom","selector":".lightbox","openEffect":"zoom","closeEffect":"zoom","loop":false});
window.onload = () => {
  lightboxQuarto.on('slide_before_load', (data) => {
    const { slideIndex, slideNode, slideConfig, player, trigger } = data;
    const href = trigger.getAttribute('href');
    if (href !== null) {
      const imgEl = window.document.querySelector(`a[href="${href}"] img`);
      if (imgEl !== null) {
        const srcAttr = imgEl.getAttribute("src");
        if (srcAttr && srcAttr.startsWith("data:")) {
          slideConfig.href = srcAttr;
        }
      }
    } 
  });

  lightboxQuarto.on('slide_after_load', (data) => {
    const { slideIndex, slideNode, slideConfig, player, trigger } = data;
    if (window.Quarto?.typesetMath) {
      window.Quarto.typesetMath(slideNode);
    }
  });

};
          </script>




</body></html>